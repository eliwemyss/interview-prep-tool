<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interview Pipeline</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            navy: { 50: '#f8fafb', 900: '#0f172a', 950: '#020617' },
            teal: { 500: '#14b8a6', 600: '#0d9488' },
            coral: { 500: '#f97316' },
          }
        }
      }
    }
  </script>
  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    
    .dark ::-webkit-scrollbar-thumb { background: #475569; }
    .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }

    .card-expand { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .card-expand.open { max-height: 1000px; }
    .shimmer { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 2s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .dark .shimmer { background: linear-gradient(90deg, #1f293950% 25%, #0f172a 50%, #1f2939 75%); }
  </style>
  <script>
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : window.location.origin;
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
  </script>
</head>
<body class="bg-white dark:bg-navy-950 transition-colors duration-300">
  <!-- Dark mode toggle -->
  <div class="fixed top-4 right-4 z-50">
    <button onclick="toggleDarkMode()" class="p-2 rounded-lg bg-gray-100 dark:bg-navy-800 hover:bg-gray-200 dark:hover:bg-navy-700 transition-colors">
      <span id="darkModeIcon" class="text-xl">üåô</span>
    </button>
  </div>

  <div class="min-h-screen bg-gradient-to-br from-navy-50 to-white dark:from-navy-950 dark:to-navy-900">
    <!-- Header -->
    <div class="bg-white dark:bg-navy-900 border-b border-gray-200 dark:border-navy-800 sticky top-0 z-40 transition-colors">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-3xl font-bold text-navy-900 dark:text-white">Interview Pipeline</h1>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Your interview progress tracker</p>
          </div>
          <nav class="flex gap-4">
            <a href="/research.html" class="px-4 py-2 rounded-lg bg-teal-500 hover:bg-teal-600 text-white font-medium transition-colors">Research</a>
            <a href="/dashboard.html" class="px-4 py-2 rounded-lg bg-navy-200 dark:bg-navy-800 text-navy-900 dark:text-white font-medium transition-colors">Dashboard</a>
          </nav>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Stats -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        <div class="bg-white dark:bg-navy-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-navy-700 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Total Companies</p>
              <p id="statCompanies" class="text-3xl font-bold text-navy-900 dark:text-white mt-2">0</p>
            </div>
            <div class="text-4xl">üè¢</div>
          </div>
        </div>
        <div class="bg-white dark:bg-navy-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-navy-700 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">In Pipeline</p>
              <p id="statPipeline" class="text-3xl font-bold text-teal-600 dark:text-teal-400 mt-2">0</p>
            </div>
            <div class="text-4xl">üìä</div>
          </div>
        </div>
        <div class="bg-white dark:bg-navy-800 rounded-xl p-6 shadow-sm border border-gray-200 dark:border-navy-700 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-600 dark:text-gray-400 text-sm font-medium">Upcoming</p>
              <p id="statUpcoming" class="text-3xl font-bold text-coral-500 dark:text-coral-400 mt-2">0</p>
            </div>
            <div class="text-4xl">üìÖ</div>
          </div>
        </div>
      </div>

      <!-- Interviews Section -->
      <div class="mb-12">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-navy-900 dark:text-white">Upcoming Interviews</h2>
          <button onclick="syncCalendar()" class="px-4 py-2 rounded-lg bg-teal-500 hover:bg-teal-600 text-white font-medium transition-colors flex items-center gap-2">
            <span id="syncIcon">üîÑ</span> Sync Calendar
          </button>
        </div>
        <div id="upcomingInterviews" class="space-y-4">
          <!-- Calendar events loaded here -->
        </div>
      </div>

      <!-- Companies Section -->
      <div>
        <h2 class="text-2xl font-bold text-navy-900 dark:text-white mb-6">Companies in Pipeline</h2>
        <div id="companiesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Company cards loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Dark mode toggle
    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      localStorage.setItem('darkMode', isDarkMode);
      document.documentElement.classList.toggle('dark');
      document.getElementById('darkModeIcon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
    }

    // Initialize dark mode
    if (isDarkMode) {
      document.documentElement.classList.add('dark');
      document.getElementById('darkModeIcon').textContent = '‚òÄÔ∏è';
    }

    // Format time
    function formatTime(date) {
      const d = new Date(date);
      const daysUntil = Math.ceil((d - new Date()) / (1000 * 60 * 60 * 24));
      if (daysUntil < 0) return 'Past';
      if (daysUntil === 0) return 'TODAY';
      if (daysUntil === 1) return 'Tomorrow';
      return `In ${daysUntil} days`;
    }

    // Load data
    async function loadData() {
      try {
        // Load calendar events
        const eventsRes = await fetch(`${API_BASE_URL}/api/calendar/events`);
        const eventsData = await eventsRes.json();
        renderUpcomingInterviews(eventsData.events || []);

        // Load companies
        const companiesRes = await fetch(`${API_BASE_URL}/api/pipeline`);
        const companiesData = await companiesRes.json();
        renderCompanies(companiesData.companies || []);

        // Update stats
        document.getElementById('statCompanies').textContent = companiesData.count || 0;
        const upcoming = (eventsData.events || []).filter(e => new Date(e.start_time) > new Date()).length;
        document.getElementById('statUpcoming').textContent = upcoming;
        document.getElementById('statPipeline').textContent = companiesData.count || 0;
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function renderUpcomingInterviews(events) {
      const container = document.getElementById('upcomingInterviews');
      if (!events.length) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No upcoming interviews</p>';
        return;
      }

      container.innerHTML = events.slice(0, 5).map(event => `
        <div class="bg-white dark:bg-navy-800 rounded-lg p-4 border border-gray-200 dark:border-navy-700 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="text-2xl">üìÖ</div>
              <div>
                <p class="font-semibold text-navy-900 dark:text-white">${event.company_name || 'Unknown'}</p>
                <p class="text-sm text-gray-600 dark:text-gray-400">${new Date(event.start_time).toLocaleDateString()} ${new Date(event.start_time).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</p>
                ${event.interviewer ? `<p class="text-sm text-gray-600 dark:text-gray-400">üë§ ${event.interviewer}</p>` : ''}
              </div>
            </div>
            <span class="px-3 py-1 rounded-full text-xs font-medium bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300">${formatTime(event.start_time)}</span>
          </div>
        </div>
      `).join('');
    }

    function renderCompanies(companies) {
      const container = document.getElementById('companiesGrid');
      if (!companies.length) {
        container.innerHTML = '<p class="text-gray-500 dark:text-gray-400 col-span-full text-center py-8">No companies in pipeline</p>';
        return;
      }

      container.innerHTML = companies.map((company, idx) => `
        <div class="bg-white dark:bg-navy-800 rounded-lg border border-gray-200 dark:border-navy-700 overflow-hidden hover:shadow-md transition-shadow">
          <!-- Card Header -->
          <div class="p-6 cursor-pointer" onclick="toggleCard(${idx})">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="text-lg font-bold text-navy-900 dark:text-white">${company.name}</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                  ${company.nextInterview ? `üìÖ ${new Date(company.nextInterview).toLocaleDateString()}` : 'No upcoming interview'}
                </p>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-medium 
                ${company.stage === 'applied' ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300' : ''}
                ${company.stage === 'research' ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-700 dark:text-yellow-300' : ''}
                ${company.stage === 'screening' ? 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300' : ''}
                ${company.stage === 'interview' ? 'bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300' : ''}
                ${company.stage === 'offer' ? 'bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300' : ''}
              ">
                ${company.stage}
              </span>
            </div>
          </div>

          <!-- Expandable Research -->
          <div id="card-${idx}" class="card-expand border-t border-gray-200 dark:border-navy-700">
            <div class="p-6 space-y-4 text-sm">
              ${company.researchData ? `
                <div>
                  <h4 class="font-semibold text-navy-900 dark:text-white mb-2">Overview</h4>
                  <p class="text-gray-700 dark:text-gray-300">${company.researchData.overview || 'No overview available'}</p>
                </div>
                ${company.researchData.techStack ? `
                  <div>
                    <h4 class="font-semibold text-navy-900 dark:text-white mb-2">Tech Stack</h4>
                    <div class="flex flex-wrap gap-2">
                      ${company.researchData.techStack.map(tech => `<span class="px-2 py-1 bg-teal-100 dark:bg-teal-900 text-teal-700 dark:text-teal-300 rounded text-xs">${tech}</span>`).join('')}
                    </div>
                  </div>
                ` : ''}
                ${company.researchData.salaryRange ? `
                  <div>
                    <h4 class="font-semibold text-navy-900 dark:text-white mb-1">üí∞ Salary</h4>
                    <p class="text-gray-700 dark:text-gray-300">$${company.researchData.salaryRange.min?.toLocaleString()} - $${company.researchData.salaryRange.max?.toLocaleString()}</p>
                  </div>
                ` : ''}
              ` : '<p class="text-gray-600 dark:text-gray-400">No research data available yet</p>'}
            </div>
          </div>
        </div>
      `).join('');
    }

    function toggleCard(idx) {
      const card = document.getElementById(`card-${idx}`);
      card.classList.toggle('open');
    }

    async function syncCalendar() {
      const btn = event.target.closest('button');
      btn.disabled = true;
      document.getElementById('syncIcon').textContent = '‚è≥';
      
      try {
        const res = await fetch(`${API_BASE_URL}/api/calendar/sync`, { method: 'POST' });
        await loadData();
      } catch (error) {
        console.error('Sync error:', error);
      } finally {
        btn.disabled = false;
        document.getElementById('syncIcon').textContent = 'üîÑ';
      }
    }

    // Load on startup
    loadData();
    setInterval(loadData, 30000); // Refresh every 30s
  </script>
</body>
</html>
