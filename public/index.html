<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interview Prep Tool - AI-Powered Research</title>
  <script>
    // Auto-detect API URL based on environment
    const API_BASE_URL = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000' 
      : window.location.origin;
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 3em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      font-size: 1.2em;
      opacity: 0.95;
    }

    .nav {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 30px;
    }

    .nav-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: 10px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .nav-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    .card {
      background: white;
      border-radius: 15px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 1.5em;
      margin-bottom: 20px;
      color: #667eea;
      font-weight: 600;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #555;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    textarea {
      min-height: 100px;
      resize: vertical;
    }

    .button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 1.1em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      width: 100%;
      font-weight: 600;
    }

    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }

    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading {
      text-align: center;
      padding: 20px;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .result {
      margin-top: 30px;
      padding: 25px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }

    .result h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.8em;
    }

    .result h4 {
      color: #764ba2;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 1.3em;
    }

    .result p {
      line-height: 1.6;
      color: #555;
      margin-bottom: 15px;
    }

    .result ul, .result ol {
      margin-left: 20px;
      margin-bottom: 15px;
    }

    .result li {
      margin-bottom: 8px;
      line-height: 1.5;
      color: #555;
    }

    .tag {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      margin: 5px;
      font-size: 0.9em;
    }

    .error {
      background: #fee;
      border-left-color: #e44;
      color: #c33;
    }

    .batch-progress {
      margin-top: 20px;
      padding: 20px;
      background: #f0f4ff;
      border-radius: 10px;
    }

    .progress-bar {
      width: 100%;
      height: 30px;
      background: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
      margin: 15px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .batch-results {
      margin-top: 20px;
    }

    .batch-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .hint {
      font-size: 0.9em;
      color: #888;
      margin-top: 5px;
    }

    .examples {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .example-chip {
      background: #f0f0f0;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .example-chip:hover {
      background: #667eea;
      color: white;
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 2em;
      }
      
      .card {
        padding: 25px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üéØ Interview Prep Tool</h1>
      <p>AI-powered company research in seconds</p>
    </div>

    <div class="nav">
      <a href="/" class="nav-btn">Research</a>
      <a href="/dashboard" class="nav-btn">Dashboard</a>
    </div>

    <div class="card">
      <h2 class="section-title">Single Company Research</h2>
      
      <div class="input-group">
        <label for="companyName">Company Name *</label>
        <input 
          type="text" 
          id="companyName" 
          placeholder="e.g., Railway, PostHog, Stripe"
          autocomplete="off"
        />
        <div class="hint">Enter the company you're interviewing with</div>
      </div>

      <div class="input-group">
        <label for="companyUrl">Company Website (optional)</label>
        <input 
          type="text" 
          id="companyUrl" 
          placeholder="e.g., https://railway.app"
          autocomplete="off"
        />
        <div class="hint">Will auto-generate if not provided</div>
      </div>

      <div class="input-group">
        <label for="role">Role/Position *</label>
        <input 
          type="text" 
          id="role" 
          placeholder="e.g., Senior Software Engineer, Product Manager"
          autocomplete="off"
        />
        <div class="hint">Your role to get salary data, interview questions, and job description</div>
      </div>

      <div class="input-group">
        <label>
          <input type="checkbox" id="deepMode" style="width: auto; margin-right: 8px;" checked>
          <strong>üî¨ Enhanced Research Mode</strong> (Glassdoor reviews, salary data, interview questions)
        </label>
        <div class="hint">Recommended: includes role-specific preparation</div>
      </div>

      <button class="button" onclick="startResearch()" id="researchBtn">
        üîç Start Research
      </button>

      <div class="examples">
        <div class="example-chip" onclick="setCompany('Railway')">Railway</div>
        <div class="example-chip" onclick="setCompany('PostHog')">PostHog</div>
        <div class="example-chip" onclick="setCompany('Stripe')">Stripe</div>
        <div class="example-chip" onclick="setCompany('Linear')">Linear</div>
        <div class="example-chip" onclick="setCompany('Anthropic')">Anthropic</div>
      </div>

      <div id="singleResult"></div>
    </div>

    <div class="card">
      <h2 class="section-title">Batch Research</h2>
      
      <div class="input-group">
        <label for="batchCompanies">Multiple Companies</label>
        <textarea 
          id="batchCompanies" 
          placeholder="Enter multiple companies, separated by commas&#10;e.g., Railway, PostHog, Toast, Stripe, Trigger.dev"
        ></textarea>
        <div class="hint">Processes all companies in parallel - much faster!</div>
      </div>

      <button class="button" onclick="startBatchResearch()" id="batchBtn">
        üöÄ Start Batch Research
      </button>

      <div id="batchResult"></div>
    </div>
  </div>

  <script>
    function setCompany(name) {
      document.getElementById('companyName').value = name;
    }

    async function startResearch() {
      const companyName = document.getElementById('companyName').value.trim();
      const companyUrl = document.getElementById('companyUrl').value.trim();
      const role = document.getElementById('role').value.trim();
      const deepMode = document.getElementById('deepMode').checked;
      const btn = document.getElementById('researchBtn');
      const resultDiv = document.getElementById('singleResult');
      
      if (!companyName) {
        alert('Please enter a company name');
        return;
      }

      if (!role) {
        alert('Please enter the role you\'re interviewing for');
        return;
      }

      btn.disabled = true;
      btn.textContent = deepMode ? 'üî¨ Enhanced Research...' : 'üîç Researching...';
      resultDiv.innerHTML = `<div class="loading">
        ${deepMode ? 'üî¨ Enhanced research' : 'Researching'} for ${role} at ${companyName}...
        ${deepMode ? '<br><small>Gathering salary data, Glassdoor reviews, interview questions, and company intel...</small>' : ''}
      </div>`;

      try {
        const response = await fetch(`${API_BASE_URL}/api/research-direct`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            companyName, 
            companyUrl,
            role,
            deepMode 
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Research failed');
        }

        displayResult(data.data, resultDiv);
      } catch (error) {
        console.error('Research error:', error);
        resultDiv.innerHTML = `<div class="result error"><h3>Error</h3><p>${error.message}</p></div>`;
      } finally {
        btn.disabled = false;
        btn.textContent = 'üîç Start Research';
      }
    }

    async function startBatchResearch() {
      const batchInput = document.getElementById('batchCompanies').value.trim();
      const btn = document.getElementById('batchBtn');
      const resultDiv = document.getElementById('batchResult');
      
      if (!batchInput) {
        alert('Please enter company names');
        return;
      }

      const companies = batchInput.split(',').map(c => c.trim()).filter(c => c);
      
      if (companies.length === 0) {
        alert('Please enter at least one company');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'üöÄ Processing...';
      resultDiv.innerHTML = '<div class="loading">Starting batch research for ' + companies.length + ' companies</div>';

      try {
        const response = await fetch(`${API_BASE_URL}/api/research-batch`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ companies: companies })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Batch research failed');
        }

        // Start polling for status
        pollBatchStatus(data.batchId, companies.length, resultDiv);
      } catch (error) {
        console.error('Batch error:', error);
        resultDiv.innerHTML = `<div class="result error"><h3>Error</h3><p>${error.message}</p></div>`;
        btn.disabled = false;
        btn.textContent = 'üöÄ Start Batch Research';
      }
    }

    async function pollBatchStatus(batchId, total, resultDiv) {
      const checkStatus = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/api/batch-status/${batchId}`);
          const data = await response.json();

          const percentage = Math.round((data.completed / data.total) * 100);
          
          resultDiv.innerHTML = `
            <div class="batch-progress">
              <h4>Processing ${data.total} companies...</h4>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%">${percentage}%</div>
              </div>
              <p>Completed: ${data.completed} / ${data.total}</p>
            </div>
          `;

          if (data.status === 'completed') {
            // Display results
            displayBatchResults(data.results, resultDiv);
            document.getElementById('batchBtn').disabled = false;
            document.getElementById('batchBtn').textContent = 'üöÄ Start Batch Research';
          } else {
            // Continue polling
            setTimeout(checkStatus, 2000);
          }
        } catch (error) {
          console.error('Status check error:', error);
          resultDiv.innerHTML += `<p class="error">Error checking status: ${error.message}</p>`;
        }
      };

      checkStatus();
    }

    function displayResult(data, container) {
      const companyName = data.company || data.companyName;
      const role = data.role;
      
      const html = `
        <div class="result">
          <h3>${companyName}</h3>
          
          <h4>üìä Overview</h4>
          <p>${data.overview}</p>
          
          ${data.products && data.products.length > 0 ? `
            <h4>üéØ Products</h4>
            <ul>
              ${data.products.map(p => `<li>${p}</li>`).join('')}
            </ul>
          ` : ''}
          
          <h4>üíª Tech Stack</h4>
          <div>
            ${data.techStack.map(t => `<span class="tag">${t}</span>`).join('')}
          </div>
          
          <h4>‚ùì Interview Questions</h4>
          <ol>
            ${data.interviewQuestions.map(q => `<li>${q}</li>`).join('')}
          </ol>
          
          <h4>üí° Preparation Tips</h4>
          <ul>
            ${data.preparationTips.map(t => `<li>${t}</li>`).join('')}
          </ul>
          
          ${data.keyTopics && data.keyTopics.length > 0 ? `
            <h4>üéì Key Topics</h4>
            <div>
              ${data.keyTopics.map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
          ` : ''}
          
          <div style="margin-top: 25px; display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="/briefing?company=${encodeURIComponent(companyName)}&role=${encodeURIComponent(role || 'Software Engineer')}" 
               target="_blank"
               style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 20px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: 600; cursor: pointer;">
              üìã View Full Interview Briefing ‚Üí
            </a>
          </div>
          
          <p style="margin-top: 20px; font-size: 0.9em; color: #888;">
            Researched at: ${new Date(data.researchedAt).toLocaleString()}
          </p>
        </div>
      `;
      
      container.innerHTML = html;
    }

    function displayBatchResults(results, container) {
      const resultsHtml = results.map(r => {
        const data = r.data;
        if (data.error) {
          return `
            <div class="batch-item">
              <h4 style="color: #e44;">${r.company}</h4>
              <p>Error: ${data.error}</p>
            </div>
          `;
        }
        
        return `
          <div class="batch-item">
            <h4>${data.companyName}</h4>
            <p>${data.overview}</p>
            <div>
              ${data.techStack.slice(0, 5).map(t => `<span class="tag">${t}</span>`).join('')}
            </div>
          </div>
        `;
      }).join('');

      const html = `
        <div class="result">
          <h3>‚úÖ Batch Complete!</h3>
          <p>All ${results.length} companies researched successfully</p>
          <div class="batch-results">
            ${resultsHtml}
          </div>
          <p style="margin-top: 20px; text-align: center;">
            <a href="/dashboard" class="button" style="display: inline-block; text-decoration: none; width: auto;">
              View in Dashboard ‚Üí
            </a>
          </p>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // Allow Enter key to submit
    document.getElementById('companyName').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        startResearch();
      }
    });
  </script>
</body>
</html>
